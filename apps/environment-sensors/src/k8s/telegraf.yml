---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: telegraf
  namespace: environment-sensors
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: telegraf
      app.kubernetes.io/instance: telegraf
  template:
    metadata:
      labels:
        app.kubernetes.io/name: telegraf
        app.kubernetes.io/instance: telegraf
    spec:
      containers:
        - name: telegraf
          image: "docker.io/library/telegraf:1.35-alpine"
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/telegraf
      volumes:
        - name: config
          configMap:
            name: telegraf

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: telegraf
  namespace: environment-sensors
data:
  telegraf.conf: |
    [agent]
      debug = true
      quiet = false

    [[outputs.influxdb_v2]]
      bucket = "Environment"
      organization = "Maker Space"
      token = "ref+sops://src/secrets.yml#/influx_token"
      urls = ["http://influxdb.influxdb.svc.cluster.local.:8086"]

    [[inputs.http_listener_v2]]
      service_address = "tcp://:8080"
      paths = ["/environment-sensor"]
      methods = ["POST"]
      http_success_code = 204
      data_format = "prometheus"
      basic_username = "environment-sensor"
      basic_password = "ref+sops://src/secrets.yml#/telegraf_password"

---
apiVersion: v1
kind: Service
metadata:
  name: telegraf-telemetry-feed
  namespace: environment-sensors
spec:
  selector:
    app.kubernetes.io/name: telegraf
  ports:
    - port: 8080
      protocol: TCP
      targetPort: http

---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: telemetry-feed
  namespace: environment-sensors
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - kind: Rule
      match: Host(`telemetry.makerspace.org.uk`) && PathPrefix(`/environment-sensor`)
      services:
        - Kind: Service
          name: telegraf-telemetry-feed
          port: 8080
  tls:
    secretName: tls-cert

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: tls-cert
  namespace: environment-sensors
spec:
  secretName: tls-cert
  duration: 2160h # 90d
  renewBefore: 720h # 30d
  privateKey:
    rotationPolicy: Always
  issuerRef:
    name: letsencrypt-cloudflare-prod
    kind: ClusterIssuer
  dnsNames:
    - telemetry.makerspace.org.uk
